const CartModel = require("../models/Cart");
const ProductModel = require("../models/Product");
const PromotionModel = require("../models/Promotion");


exports.getAllCarts = async (req, res) => {
  try {
    // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà
    const currentUsername = req.user?.username;
    const carts = await CartModel.find({ userName: currentUsername });
    res.json(carts);
  } catch (error) {
    res
      .status(500)
      .json({ message: error.message || "Failed to get cart items." });
  }
};

// üìå POST /carts - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
exports.createCart = async (req, res) => {
  try {
    const { productId, quantity, pack, userName, barcode, promotionId } = req.body;
    const currentUsername = req.user?.username;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    if (!productId || !quantity) {
      return res.status(400).json({ message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô' });
    }

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏ß‡∏°‡∏£‡∏≠‡∏¢ userName
    if (userName && userName !== currentUsername) {
      return res.status(403).json({ message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏ô‡∏ô‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ' });
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    const product = await ProductModel.findById(productId);
    if (!product) {
      return res.status(404).json({ message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á (active + ‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ + ‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å)
    const now = new Date();
    const allActiveLots = (product.lots || []).filter(lot => 
      lot.status === 'active' && 
      lot.quantity > 0 && 
      (lot.expirationDate ? new Date(lot.expirationDate) > now : true)
    );
    
    // ‡∏´‡∏≤‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô ‡πÇ‡∏î‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å Promotion model
    const promoUsedLots = new Set();
    let promoAvailableQty = 0;
    let isPromotionProduct = false;
    
    try {
      const activePromotions = await PromotionModel.find({
        productId: product._id,
        validityStart: { $lte: now },
        validityEnd: { $gte: now }
      });
      
      for (const promo of activePromotions) {
        if (promo.appliedLots && Array.isArray(promo.appliedLots)) {
          promo.appliedLots.forEach(lotNumber => promoUsedLots.add(lotNumber));
        }
      }
      
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ promotionId ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô
      if (promotionId) {
        const currentPromo = activePromotions.find(p => p._id.toString() === promotionId);
        if (currentPromo && currentPromo.appliedLots && Array.isArray(currentPromo.appliedLots)) {
          isPromotionProduct = true;
          const eligibleLots = allActiveLots.filter(lot => currentPromo.appliedLots.includes(lot.lotNumber));
          promoAvailableQty = eligibleLots.reduce((sum, lot) => sum + lot.quantity, 0);
        }
      }
    } catch (error) {
      // Error fetching promotions - handled silently
    }
    
    // ‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô)
    const normalSaleLots = allActiveLots.filter(lot => !promoUsedLots.has(lot.lotNumber));
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
    let availableQuantity;
    let stockMessage;
    
    if (isPromotionProduct) {
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
      availableQuantity = promoAvailableQty;
      stockMessage = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${availableQuantity} ‡∏ä‡∏¥‡πâ‡∏ô`;
    } else {
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô
      if (normalSaleLots.length === 0) {
        return res.status(400).json({ message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡πá‡∏≠‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô)' });
      }
      availableQuantity = normalSaleLots.reduce((sum, lot) => sum + lot.quantity, 0);
      stockMessage = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${availableQuantity} ‡∏ä‡∏¥‡πâ‡∏ô`;
    }
    
    const requestedQuantity = pack ? quantity * product.packSize : quantity;
    if (requestedQuantity > availableQuantity) {
      return res.status(400).json({ 
        message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ${stockMessage}` 
      });
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    let price;
    if (promotionId) {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ promotionId ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô
      try {
        const promotion = await PromotionModel.findById(promotionId);
        if (promotion) {
          price = promotion.discountedPrice;
        } else {
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
          price = pack ? product.sellingPricePerPack : product.sellingPricePerUnit;
        }
      } catch (error) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
        price = pack ? product.sellingPricePerPack : product.sellingPricePerUnit;
      }
    } else {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ promotionId ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
      price = pack ? product.sellingPricePerPack : product.sellingPricePerUnit;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô)
    const allCartItemsForProduct = await CartModel.find({ 
      productId, 
      userName: currentUsername, 
      promotionId: promotionId || null 
    });
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
    const totalCartQuantity = allCartItemsForProduct.reduce((sum, cartItem) => {
      return sum + (cartItem.pack ? cartItem.quantity * cartItem.packSize : cartItem.quantity);
    }, 0);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const newTotalQuantity = totalCartQuantity + (pack ? quantity * product.packSize : quantity);
    if (newTotalQuantity > availableQuantity) {
      return res.status(400).json({ 
        message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ${stockMessage} (‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏°‡∏µ ${totalCartQuantity} ‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß) - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠: ${pack ? quantity + ' ‡πÅ‡∏û‡πá‡∏Ñ (' + (quantity * product.packSize) + ' ‡∏ä‡∏¥‡πâ‡∏ô)' : quantity + ' ‡∏ä‡∏¥‡πâ‡∏ô'}` 
      });
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÇ‡∏î‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° barcode ‡πÅ‡∏•‡∏∞ promotionId
    const existingItem = await CartModel.findOne({ productId, userName: currentUsername, barcode: barcode || (pack ? product.barcodePack : product.barcodeUnit), promotionId: promotionId || null });

    if (existingItem) {
      // ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      existingItem.quantity += quantity;
      const updatedItem = await existingItem.save();
      return res.json(updatedItem);
    }

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
      const cart = new CartModel({
      productId,
      name: product.productName,
      price,
      image: product.productImage,
      quantity,
      userName: currentUsername,
        pack,
        barcode: barcode || (pack ? product.barcodePack : product.barcodeUnit),
        promotionId: promotionId || null,
        packSize: product.packSize || 1
    });

    const newItem = await cart.save();
    res.status(201).json(newItem);
  } catch (error) {
    res.status(500).json({ message: error.message || "Something went wrong!" });
  }
};


  
  exports.getCartsByUserName = async (req, res) => {

  try {
    const { userName } = req.params;
    const currentUsername = req.user?.username;
    if (userName !== currentUsername) {
      return res.status(403).json({ message: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï' });
    }
    const carts = await CartModel.find({ userName });
    res.json(carts);
  } catch (error) {
    res
      .status(500)
      .json({ message: error.message || "Failed to get cart items." });
  }
};

  
  // üìå DELETE /cart/{userId} - ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
exports.deleteAllCarts = async (req, res) => {
    const { userName  } = req.params;
    const currentUsername = req.user?.username;
    if (userName !== currentUsername) {
      return res.status(403).json({ message: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï' });
    }
    try {
      const result = await CartModel.deleteMany({ userName });
  
      if (result.deletedCount > 0) {
        return res.json({ message: "All cart items removed!" });
      } else {
        return res.json({ message: "No cart items found." });
      }
    } catch (error) {
      res.status(500).json({ message: error.message || "Failed to delete cart items." });
    }
  };
  
  exports.updateCartById = async (req, res) => {
    try {
      const { id } = req.params;
      const { quantity, pack } = req.body;

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á quantity ‡∏´‡∏£‡∏∑‡∏≠ pack ‡∏°‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (quantity === undefined && pack === undefined) {
        return res.status(400).json({ message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' });
      }

      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      const cart = await CartModel.findById(id);
      if (!cart) {
        return res.status(404).json({ message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤' });
      }

      // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      const currentUsername = req.user?.username;
      if (cart.userName !== currentUsername) {
        return res.status(403).json({ message: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï' });
      }

      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å
      const product = await ProductModel.findById(cart.productId);
      if (!product) {
        return res.status(404).json({ message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' });
      }

      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏û‡πá‡∏Ñ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô (‡πÇ‡∏õ‡∏£‡∏Ø ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏î‡πâ‡∏≤‡∏ô add-with-barcode)
      if (cart.promotionId && pack !== undefined && pack === true) {
        return res.status(400).json({ message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏û‡πá‡∏Ñ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡πÑ‡∏î‡πâ' });
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢
      const now = new Date();
      const allActiveLots = (product.lots || []).filter(lot => 
        lot.status === 'active' && 
        lot.quantity > 0 && 
        (lot.expirationDate ? new Date(lot.expirationDate) > now : true)
      );
      
      // ‡∏´‡∏≤‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
      const promoUsedLots = new Set();
      let availableQuantity = 0;
      
      try {
        const activePromotions = await PromotionModel.find({
          productId: product._id,
          validityStart: { $lte: now },
          validityEnd: { $gte: now }
        });
        
        for (const promo of activePromotions) {
          if (promo.appliedLots && Array.isArray(promo.appliedLots)) {
            promo.appliedLots.forEach(lotNumber => promoUsedLots.add(lotNumber));
          }
        }
        
        // ‡∏ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        if (cart.promotionId) {
          const currentPromo = activePromotions.find(p => p._id.toString() === cart.promotionId.toString());
          if (currentPromo && currentPromo.appliedLots && Array.isArray(currentPromo.appliedLots)) {
            const eligibleLots = allActiveLots.filter(lot => currentPromo.appliedLots.includes(lot.lotNumber));
            availableQuantity = eligibleLots.reduce((sum, lot) => sum + lot.quantity, 0);
          }
        } else {
          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô
          const normalSaleLots = allActiveLots.filter(lot => !promoUsedLots.has(lot.lotNumber));
          if (normalSaleLots.length === 0) {
            return res.status(400).json({ message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡πá‡∏≠‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô)' });
          }
          availableQuantity = normalSaleLots.reduce((sum, lot) => sum + lot.quantity, 0);
        }
      } catch (error) {
        // Error fetching promotions - handled silently
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô)
      const effectivePack = (pack !== undefined) ? pack : cart.pack;
      const effectiveQuantity = (quantity !== undefined) ? quantity : cart.quantity;
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
      const requestedQuantity = effectivePack ? effectiveQuantity * product.packSize : effectiveQuantity;
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
      const otherCartItemsForProduct = await CartModel.find({ 
        productId: cart.productId, 
        userName: currentUsername, 
        promotionId: cart.promotionId || null,
        _id: { $ne: cart._id } // ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      });
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÅ‡∏•‡πâ‡∏ß
      const otherCartQuantity = otherCartItemsForProduct.reduce((sum, cartItem) => {
        return sum + (cartItem.pack ? cartItem.quantity * cartItem.packSize : cartItem.quantity);
      }, 0);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const totalRequestedQuantity = otherCartQuantity + requestedQuantity;
      if (totalRequestedQuantity > availableQuantity) {
        const stockMessage = cart.promotionId ? 
          `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${availableQuantity} ‡∏ä‡∏¥‡πâ‡∏ô` :
          `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${availableQuantity} ‡∏ä‡∏¥‡πâ‡∏ô`;
        
        return res.status(400).json({ 
          message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ${stockMessage} (‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏°‡∏µ ${otherCartQuantity} ‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß) - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠: ${effectivePack ? effectiveQuantity + ' ‡πÅ‡∏û‡πá‡∏Ñ (' + (effectiveQuantity * product.packSize) + ' ‡∏ä‡∏¥‡πâ‡∏ô)' : effectiveQuantity + ' ‡∏ä‡∏¥‡πâ‡∏ô'}` 
        });
      }

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏û‡πá‡∏Ñ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á
      if (quantity !== undefined) {
        if (quantity <= 0) {
          return res.status(400).json({ message: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0' });
        }
        cart.quantity = quantity;
      }
      if (pack !== undefined) {
        cart.pack = pack;
        cart.price = pack ? product.sellingPricePerPack : product.sellingPricePerUnit;
        cart.barcode = pack ? product.barcodePack : product.barcodeUnit;

        // ‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ã‡πâ‡∏≥ (merge) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà key ‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
        const duplicate = await CartModel.findOne({
          _id: { $ne: cart._id },
          userName: cart.userName,
          productId: cart.productId,
          barcode: cart.barcode,
          promotionId: cart.promotionId || null,
        });
        if (duplicate) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á merge ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          const mergedQuantityUnits = cart.pack
            ? (cart.quantity + duplicate.quantity) * product.packSize
            : (cart.quantity + duplicate.quantity);
          
          if (mergedQuantityUnits > availableQuantity) {
            const stockMessage = cart.promotionId ? 
              `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢ (${availableQuantity} ‡∏ä‡∏¥‡πâ‡∏ô)` :
              `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (${availableQuantity} ‡∏ä‡∏¥‡πâ‡∏ô)`;
            
            return res.status(400).json({
              message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å - ${stockMessage}`
            });
          }
          cart.quantity = cart.quantity + duplicate.quantity;
          await duplicate.deleteOne();
        }
      }

      const updatedCart = await cart.save();
      res.json(updatedCart);
    } catch (error) {
      res.status(500).json({ message: error.message || "Something went wrong!" });
    }
  };
  
  
  // üìå DELETE /cart/{id} - ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏° ID
exports.deleteCartById = async (req, res) => {
    try {
      const { id } = req.params;
      const currentUsername = req.user?.username;
      const item = await CartModel.findById(id);
      if (!item) {
        return res.status(404).json({ message: "Item not found!" });
      }
      if (item.userName !== currentUsername) {
        return res.status(403).json({ message: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï' });
      }
      await item.deleteOne();
      res.status(200).json({ message: "Item deleted successfully!" });
    } catch (error) {
      res.status(500).json({ message: error.message || "Failed to delete cart item." });
    }
  };
  
  exports.createCartWithBarcode = async (req, res) => {
    const { barcode, quantity, userName } = req.body;
    const currentUsername = req.user?.username;

    if (!barcode || !quantity) {
      return res.status(400).json({ message: "Product information is missing!" });
    }
    if (userName && userName !== currentUsername) {
      return res.status(403).json({ message: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï' });
    }

    try {
      const now = new Date();
      // 1) ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô
      const promotion = await PromotionModel.findOne({ barcode }).lean();
      if (promotion) {
        if (!(new Date(promotion.validityStart) <= now && now <= new Date(promotion.validityEnd))) {
          return res.status(400).json({ message: "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°" });
        }
        const product = await ProductModel.findById(promotion.productId);
        if (!product) return res.status(404).json({ message: "Product not found!" });

        let promoAvailableQty = product.totalQuantity; // fallback ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        if (Array.isArray(promotion.appliedLots) && promotion.appliedLots.length > 0) {
          const eligibleLots = (product.lots || []).filter(l => 
            l.status === 'active' && 
            l.quantity > 0 && 
            (l.expirationDate ? new Date(l.expirationDate) > now : true) && 
            promotion.appliedLots.includes(l.lotNumber)
          );
          if (eligibleLots.length === 0) return res.status(400).json({ message: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ" });
          promoAvailableQty = eligibleLots.reduce((sum, l) => sum + l.quantity, 0);
        }

        const pack = false; // ‡πÇ‡∏õ‡∏£‡∏Ø ‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        const requestedQuantity = quantity;
        if (requestedQuantity > promoAvailableQty) {
          return res.status(400).json({ message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡πÑ‡∏î‡πâ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡∏Ø ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${promoAvailableQty} ‡∏´‡∏ô‡πà‡∏ß‡∏¢` });
        }
        const price = promotion.discountedPrice;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô)
        const existingItem = await CartModel.findOne({ 
          productId: product._id, 
          userName: currentUsername, 
          barcode: product.barcodeUnit, // ‡πÉ‡∏ä‡πâ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á
          promotionId: promotion._id 
        });
        if (existingItem) {
          const newTotalQuantity = existingItem.quantity + quantity;
          if (newTotalQuantity > promoAvailableQty) {
            return res.status(400).json({ message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡πÑ‡∏î‡πâ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡∏Ø ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${promoAvailableQty} ‡∏´‡∏ô‡πà‡∏ß‡∏¢` });
          }
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          existingItem.quantity += quantity;
          existingItem.price = promotion.discountedPrice; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          const updatedItem = await existingItem.save();
          return res.json(updatedItem);
        }

        const cart = new CartModel({
          productId: product._id,
          name: product.productName,
          price,
          image: product.productImage,
          quantity,
          userName: currentUsername,
          pack,
          barcode: product.barcodeUnit, // ‡πÉ‡∏ä‡πâ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏ó‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô
          promotionId: promotion._id,
          packSize: product.packSize || 1
        });
        const newItem = await cart.save();
        return res.status(201).json(newItem);
      }

      // 2) ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÅ‡∏û‡πá‡∏Ñ/‡∏ä‡∏¥‡πâ‡∏ô)
      const product = await ProductModel.findOne({ $or: [{ barcodePack: barcode }, { barcodeUnit: barcode }] });
      if (!product) return res.status(404).json({ message: "Product not found!" });

      const isPack = barcode === product.barcodePack;
      const pack = isPack;
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô)
      const allActiveLots = (product.lots || []).filter(l => 
        l.status === 'active' && 
        l.quantity > 0 && 
        (l.expirationDate ? new Date(l.expirationDate) > now : true)
      );
      
      // ‡∏´‡∏≤‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô ‡πÇ‡∏î‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å Promotion model
      const promoUsedLots = new Set();
      try {
        const activePromotions = await PromotionModel.find({
          productId: product._id,
          validityStart: { $lte: now },
          validityEnd: { $gte: now }
        });
        
        for (const promo of activePromotions) {
          if (promo.appliedLots && Array.isArray(promo.appliedLots)) {
            promo.appliedLots.forEach(lotNumber => promoUsedLots.add(lotNumber));
          }
        }
      } catch (error) {
        // Error fetching promotions - handled silently
      }
      
      // ‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô)
      const normalSaleLots = allActiveLots.filter(lot => !promoUsedLots.has(lot.lotNumber));
      
      if (normalSaleLots.length === 0) {
        return res.status(400).json({ message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡πá‡∏≠‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô)' });
      }
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥
      const normalSaleQuantity = normalSaleLots.reduce((sum, lot) => sum + lot.quantity, 0);
      
      const requestedQuantity = pack ? quantity * product.packSize : quantity;
      if (requestedQuantity > normalSaleQuantity) {
        return res.status(400).json({ 
          message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${normalSaleQuantity} ‡∏ä‡∏¥‡πâ‡∏ô (‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥)` 
        });
      }
      
      const price = pack ? product.sellingPricePerPack : product.sellingPricePerUnit;

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô)
      const allCartItemsForProduct = await CartModel.find({ 
        productId: product._id, 
        userName: currentUsername, 
        promotionId: null 
      });
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
      const totalCartQuantity = allCartItemsForProduct.reduce((sum, cartItem) => {
        return sum + (cartItem.pack ? cartItem.quantity * cartItem.packSize : cartItem.quantity);
      }, 0);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const newTotalQuantity = totalCartQuantity + (pack ? quantity * product.packSize : quantity);
      if (newTotalQuantity > normalSaleQuantity) {
        return res.status(400).json({ 
          message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${normalSaleQuantity} ‡∏ä‡∏¥‡πâ‡∏ô (‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏°‡∏µ ${totalCartQuantity} ‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß) - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠: ${pack ? quantity + ' ‡πÅ‡∏û‡πá‡∏Ñ (' + (quantity * product.packSize) + ' ‡∏ä‡∏¥‡πâ‡∏ô)' : quantity + ' ‡∏ä‡∏¥‡πâ‡∏ô'}` 
        });
      }

      const existingItem = await CartModel.findOne({ productId: product._id, userName: currentUsername, barcode, promotionId: null });
      if (existingItem) {
        existingItem.quantity += quantity;
        const updatedItem = await existingItem.save();
        return res.json(updatedItem);
      }

      const cart = new CartModel({
        productId: product._id,
        name: product.productName,
        price,
        image: product.productImage,
        quantity,
        userName: currentUsername,
        pack,
        barcode,
        promotionId: null,
        packSize: product.packSize || 1
      });
      const newItem = await cart.save();
      return res.status(201).json(newItem);
    } catch (error) {
      res.status(500).json({ message: error.message || "Something went wrong!" });
    }
  };
  